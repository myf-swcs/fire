<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沉浸式防火防災 3D 訓練</title>
    <!-- 引入 Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.1);
            --glass-bright: rgba(255, 255, 255, 0.25);
            --danger: #ff4757;
            --success: #2ed573;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #0a0a0a;
            font-family: -apple-system, "SF Pro Display", "PingFang TC", system-ui, sans-serif;
            color: white;
            cursor: crosshair;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-layer {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            pointer-events: none;
        }

        .main-panel {
            background: var(--glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 50px;
            width: 85%;
            max-width: 700px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            pointer-events: auto;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            color: rgba(255,255,255,0.6);
        }

        h1 {
            font-size: 2.5rem;
            margin: 0 0 20px 0;
            font-weight: 800;
            letter-spacing: -1px;
        }

        #question-box {
            font-size: 1.6rem;
            margin-bottom: 40px;
            font-weight: 500;
            line-height: 1.4;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .option-card {
            background: var(--glass-bright);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 30px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
            overflow: hidden;
        }

        /* Vision Pro Gaze Effect */
        .option-card:hover {
            background: rgba(255,255,255,0.9);
            color: #000;
            transform: translateZ(50px) scale(1.05);
            box-shadow: 0 0 40px rgba(255,255,255,0.4);
        }

        .option-card:active {
            transform: translateZ(20px) scale(0.95);
        }

        #system-msg {
            margin-top: 30px;
            font-size: 1.1rem;
            min-height: 1.5em;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        /* 沉浸式濾鏡效果 */
        #danger-vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            background: radial-gradient(circle, transparent 50%, rgba(255, 71, 87, 0) 100%);
            transition: background 0.5s;
        }

        .alert-active {
            background: radial-gradient(circle, transparent 30%, rgba(255, 71, 87, 0.4) 100%) !important;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .shake {
            animation: shake-anim 0.5s;
        }

        @keyframes shake-anim {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>

    <div id="danger-vignette"></div>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="main-panel" id="main-panel">
            <div class="status-bar">
                <span>模擬狀態: 運作中</span>
                <span>核心分數: <span id="score">0</span></span>
            </div>
            <h1 id="title">空間防火訓練</h1>
            
            <div id="content-area">
                <div id="question-box">系統初始化中...</div>
                <div class="options-grid">
                    <div class="option-card" id="opt0" onclick="selectAnswer(0)">載入中</div>
                    <div class="option-card" id="opt1" onclick="selectAnswer(1)">載入中</div>
                </div>
                <div id="system-msg"></div>
            </div>
        </div>
    </div>

<script>
    // --- 沉浸式情境資料 ---
    const quizData = [
        { q: "【情境：廚房起火】炒菜時油鍋燃起烈火，你的直覺反應是？", options: ["迅速蓋上鍋蓋切斷熱源", "用水龍頭冷水直接澆滅"], correct: 0, voice: "廚房起火了！快決定處理方式。" },
        { q: "【情境：濃煙籠罩】逃生門外充滿黑色濃煙，看不清地板，此時應？", options: ["低姿勢爬行，尋找逃生口", "挺直身體快速衝過煙霧區"], correct: 0, voice: "煙霧遮蔽了視線。保持冷靜，採取低姿勢。" },
        { q: "【情境：地震發生】地面開始劇烈晃動，物品掉落聲四起，你該？", options: ["立即跑向室外空曠處", "就地趴下、找掩護並穩住"], correct: 1, voice: "強震來襲！立刻尋求掩護。" },
        { q: "【情境：受困高樓】房間門把發燙，無法開門逃生，應如何應對？", options: ["關門並塞住縫隙，在視窗求救", "強行開門，用濕毛巾摀口鼻衝出"], correct: 0, voice: "門把已經發燙。不要開門！設法防止煙霧進入。" },
        { q: "【情境：衣物著火】逃生時發現袖口起火燃燒，應採取動作？", options: ["快速跑步利用風力吹滅", "停、躺、捲，滾動滅火"], correct: 1, voice: "你的衣服著火了！停下，躺下，開始翻滾。" }
    ];

    let currentIdx = 0;
    let score = 0;
    let lock = false;

    // --- Three.js 空間背景 ---
    let scene, camera, renderer, extinguisher, particles, fogEffect;

    function initSpatialEnvironment() {
        scene = new THREE.Scene();
        // 加入迷霧感 (沉浸式細節)
        scene.fog = new THREE.FogExp2(0x0a0a0a, 0.05);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 6;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 燈光效果
        const light = new THREE.SpotLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // 3D 滅火器
        extinguisher = createExtinguisher();
        scene.add(extinguisher);

        // 動態火星粒子
        const pGeo = new THREE.BufferGeometry();
        const pCount = 2000;
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount*3; i++) pPos[i] = (Math.random() - 0.5) * 20;
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const pMat = new THREE.PointsMaterial({ size: 0.05, color: 0xffa502, transparent: true, opacity: 0.6 });
        particles = new THREE.Points(pGeo, pMat);
        scene.add(particles);

        animate();
    }

    function createExtinguisher() {
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.8, 32), new THREE.MeshPhongMaterial({ color: 0xc0392b }));
        const head = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.4, 0.3, 32), new THREE.MeshPhongMaterial({ color: 0x333333 }));
        head.position.y = 1;
        group.add(body);
        group.add(head);
        return group;
    }

    function animate() {
        requestAnimationFrame(animate);
        extinguisher.rotation.y += 0.005;
        extinguisher.position.y = Math.sin(Date.now() * 0.001) * 0.2;
        particles.rotation.y += 0.001;
        renderer.render(scene, camera);
    }

    // --- 沉浸式互動邏輯 ---
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }
    }

    function renderStep() {
        if (currentIdx >= quizData.length) {
            showSummary();
            return;
        }

        const step = quizData[currentIdx];
        document.getElementById('question-box').innerText = step.q;
        document.getElementById('opt0').innerText = step.options[0];
        document.getElementById('opt1').innerText = step.options[1];
        document.getElementById('system-msg').innerText = "等待指令...";
        document.getElementById('system-msg').style.color = "white";
        
        speak(step.voice);
        lock = false;
    }

    function selectAnswer(idx) {
        if (lock) return;
        lock = true;

        const correct = quizData[currentIdx].correct;
        const msg = document.getElementById('system-msg');
        const vignette = document.getElementById('danger-vignette');
        const panel = document.getElementById('main-panel');

        if (idx === correct) {
            score += 20;
            msg.innerText = "✅ 判斷正確。環境壓力下降。";
            msg.style.color = "var(--success)";
            scene.fog.density = 0.05; // 恢復清晰
            vignette.classList.remove('alert-active');
        } else {
            msg.innerText = "❌ 警告：此決策將導致生命威脅！";
            msg.style.color = "var(--danger)";
            panel.classList.add('shake');
            setTimeout(() => panel.classList.remove('shake'), 500);
            
            // 沉浸式負面回饋：濃煙增加
            scene.fog.density = 0.3; 
            vignette.classList.add('alert-active');
            speak("警告，偵測到危險等級上升。");
        }

        document.getElementById('score').innerText = score;

        setTimeout(() => {
            currentIdx++;
            renderStep();
        }, 2500);
    }

    function showSummary() {
        const content = document.getElementById('content-area');
        const finalRank = score >= 100 ? "特級防火指揮官" : score >= 60 ? "安全防護員" : "急需重新訓練";
        
        content.innerHTML = `
            <div style="padding: 20px;">
                <h2 style="font-size: 2rem; color: var(--success);">模擬訓練結束</h2>
                <p style="font-size: 1.3rem;">空間認知分數：${score}</p>
                <p style="font-size: 1.5rem; font-weight: bold;">評級：${finalRank}</p>
                <div style="margin-top: 30px;">
                    <button class="option-card" style="width: 100%; pointer-events: auto;" onclick="location.reload()">重新啟動模擬系統</button>
                </div>
            </div>
        `;
        speak(`訓練結束。您的分數是${score}分。評級為${finalRank}。`);
    }

    // 螢幕尺寸自適應
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 啟動環境
    window.onload = () => {
        initSpatialEnvironment();
        setTimeout(renderStep, 1000); // 延遲 1 秒啟動以確保瀏覽器準備好
    };
</script>

</body>
</html>